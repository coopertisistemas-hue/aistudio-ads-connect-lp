<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exemplo de Integra√ß√£o - ADS Connect SDK</title>
    
    <!-- ADS Connect SDK -->
    <script src="/ads-connect-sdk.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .ad-container {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            background: #f9f9f9;
        }
        
        .ad-container img {
            max-width: 100%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .ad-container img:hover {
            transform: scale(1.05);
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <h1>Exemplo de Integra√ß√£o - ADS Connect</h1>
    
    <div class="status" id="status">
        Inicializando SDK...
    </div>
    
    <!-- Slot de An√∫ncio Header -->
    <div id="ad-slot-header" class="ad-container">
        <p>Carregando an√∫ncio...</p>
    </div>
    
    <h2>Conte√∫do do Site</h2>
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
    
    <!-- Slot de An√∫ncio Sidebar -->
    <div id="ad-slot-sidebar" class="ad-container">
        <p>Carregando an√∫ncio...</p>
    </div>
    
    <script>
        // ========================================================================
        // CONFIGURA√á√ÉO
        // ========================================================================
        
        const CONFIG = {
            siteId: 'SEU-SITE-UUID-AQUI',
            apiKey: 'SUA-API-KEY-AQUI',
            supabaseUrl: 'https://hwugnqevkeymqoahnwfb.supabase.co',
            debug: true, // Ativar logs de debug
        };
        
        // ========================================================================
        // 1. INICIALIZAR SDK
        // ========================================================================
        
        try {
            ADSConnect.init(CONFIG);
            updateStatus('‚úÖ SDK inicializado com sucesso!');
        } catch (error) {
            updateStatus('‚ùå Erro ao inicializar SDK: ' + error.message);
            console.error(error);
        }
        
        // ========================================================================
        // 2. BUSCAR AN√öNCIOS
        // ========================================================================
        
        async function fetchAd(slotPosition) {
            try {
                const response = await fetch(`${CONFIG.supabaseUrl}/functions/v1/serve-ad-optimized`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Site-Key': CONFIG.apiKey,
                    },
                    body: JSON.stringify({
                        site_id: CONFIG.siteId,
                        slot_position: slotPosition,
                        user_context: {
                            device: ADSConnect.detectDevice(),
                        },
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.ad) {
                    return data.ad;
                }
                
                return null;
            } catch (error) {
                console.error('Erro ao buscar an√∫ncio:', error);
                return null;
            }
        }
        
        // ========================================================================
        // 3. RENDERIZAR AN√öNCIO
        // ========================================================================
        
        function renderAd(containerId, ad) {
            const container = document.getElementById(containerId);
            
            if (!ad) {
                container.innerHTML = '<p style="color: #999;">Nenhum an√∫ncio dispon√≠vel</p>';
                return;
            }
            
            // Criar elemento de imagem
            const img = document.createElement('img');
            img.src = ad.creative.url;
            img.alt = 'An√∫ncio';
            img.width = ad.creative.width;
            img.height = ad.creative.height;
            
            // Limpar container e adicionar imagem
            container.innerHTML = '';
            container.appendChild(img);
            
            // ====================================================================
            // 4. TRACKING DE IMPRESS√ÉO VIEWABLE
            // ====================================================================
            
            const tracker = new ViewableImpressionTracker(container, {
                adId: ad.id,
                slotId: containerId, // Usar ID do container como slot_id
            });
            
            updateStatus(`üìä Tracking de impress√£o configurado para ${containerId}`);
            
            // ====================================================================
            // 5. TRACKING DE CLIQUE
            // ====================================================================
            
            const clickTracker = new ClickTracker();
            
            img.addEventListener('click', async (event) => {
                await clickTracker.handleClick(event, {
                    adId: ad.id,
                    impressionId: tracker.getImpressionId(),
                    slotId: containerId,
                    fallbackUrl: ad.click_url, // URL de fallback
                });
            });
            
            updateStatus(`üñ±Ô∏è Tracking de clique configurado para ${containerId}`);
        }
        
        // ========================================================================
        // 6. CARREGAR AN√öNCIOS
        // ========================================================================
        
        async function loadAds() {
            updateStatus('üîÑ Carregando an√∫ncios...');
            
            // Carregar an√∫ncio do header
            const headerAd = await fetchAd('header');
            renderAd('ad-slot-header', headerAd);
            
            // Carregar an√∫ncio da sidebar
            const sidebarAd = await fetchAd('sidebar');
            renderAd('ad-slot-sidebar', sidebarAd);
            
            updateStatus('‚úÖ An√∫ncios carregados e tracking configurado!');
        }
        
        // ========================================================================
        // HELPERS
        // ========================================================================
        
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            console.log(message);
        }
        
        // ========================================================================
        // INICIAR
        // ========================================================================
        
        // Carregar an√∫ncios quando a p√°gina estiver pronta
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAds);
        } else {
            loadAds();
        }
    </script>
</body>
</html>
